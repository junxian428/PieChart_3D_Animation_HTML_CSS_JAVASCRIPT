<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='UTF-8' />
  <title>3D Pie Chart with Labels</title>
  <style>
    body { margin: 0; background: #001133; overflow: hidden; }
    canvas { display: block; }
  </style>
</head>
<body>

<script type='module'>
import * as THREE from 'https://esm.sh/three@0.160.0';
import { OrbitControls } from 'https://esm.sh/three@0.160.0/examples/jsm/controls/OrbitControls.js';

// ---------- SCENE ----------
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x001133); // Dark Blue

// ---------- CAMERA ----------
const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
camera.position.set(0, 8, 12);

// ---------- RENDERER ----------
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(window.devicePixelRatio);
document.body.appendChild(renderer.domElement);

// ---------- CONTROLS ----------
const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;

// ---------- LIGHT ----------
scene.add(new THREE.AmbientLight(0xffffff, 0.6));
const light = new THREE.DirectionalLight(0xffffff, 0.8);
light.position.set(5, 10, 7);
scene.add(light);

// ---------- PIE GROUP ----------
const pieGroup = new THREE.Group();
scene.add(pieGroup);

// ---------- DATA FROM POWER BI JSON ----------
const jsonData = '[{"category":"Incomplete","value":7},{"category":"Completed","value":122},{"category":"Pending Receive","value":7}]';
const jsonData2 = JSON.parse(jsonData);

const data = jsonData2.map(d => ({
  category: d.category,
  value: d.value,
  color: Math.floor(Math.random() * 0xffffff)
}));

const total = data.reduce((s,d) => s + d.value, 0);
let startAngle = 0;

// ---------- FUNCTION TO CREATE LABELS ----------
function createLabel(text, x, y, z) {
  const canvas = document.createElement('canvas');
  const size = 500;
  canvas.width = size;
  canvas.height = size;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = 'white';
  ctx.font = '40px Arial';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(text, size/2, size/2);

  const texture = new THREE.CanvasTexture(canvas);
  const material = new THREE.SpriteMaterial({ map: texture });
  const sprite = new THREE.Sprite(material);
  sprite.scale.set(2, 2, 1);
  sprite.position.set(x, y, z);
  return sprite;
}

// ---------- CREATE PIE ----------
const radius = 4;
const height = 1;

data.forEach(slice => {
  const angle = (slice.value / total) * Math.PI * 2;

  // Slice shape
  const shape = new THREE.Shape();
  shape.moveTo(0,0);
  shape.absarc(0,0,radius,startAngle,startAngle+angle);
  shape.lineTo(0,0);

  const geometry = new THREE.ExtrudeGeometry(shape,{ depth: height, bevelEnabled: false });
  const material = new THREE.MeshStandardMaterial({ color: slice.color });
  const mesh = new THREE.Mesh(geometry, material);
  mesh.rotation.x = -Math.PI/2;
  pieGroup.add(mesh);

  // Label
  const midAngle = startAngle + angle/2;
  const labelRadius = radius * 0.7;
  const x = labelRadius * Math.cos(midAngle);
  const z = labelRadius * Math.sin(midAngle);
  const y = height + 0.2; // slightly above pie
  const percent = ((slice.value/total)*100).toFixed(1) + '%';
  const labelText = slice.category + ' | ' + slice.value + ' (' + percent + ')';
  const label = createLabel(labelText, x, y, z);
  pieGroup.add(label);

  startAngle += angle;
});

// ---------- ANIMATION ----------
function animate() {
  requestAnimationFrame(animate);
  pieGroup.rotation.y += 0.005;
  controls.update();
  renderer.render(scene, camera);
}
animate();

// ---------- WINDOW RESIZE ----------
window.addEventListener('resize', () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>

</body>
</html>
